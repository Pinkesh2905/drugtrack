{% extends 'base.html' %}
{% load static %}

{% block title %}Compliance Report - DrugTrack{% endblock %}

{% block extra_css %}
<style>
    .compliance-header {
        background: linear-gradient(135deg, #4c51bf 0%, #805ad5 100%);
        color: white;
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
    }
    
    .compliance-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        margin-bottom: 2rem;
        transition: all 0.3s ease;
    }
    
    .compliance-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
    }
    
    .compliance-score {
        font-size: 3rem;
        font-weight: bold;
        text-align: center;
        margin: 1rem 0;
    }
    
    .score-excellent { color: #48bb78; }
    .score-good { color: #4299e1; }
    .score-warning { color: #ed8936; }
    .score-critical { color: #f56565; }
    
    .compliance-ring {
        width: 150px;
        height: 150px;
        margin: 0 auto;
        position: relative;
    }
    
    .ring-score {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 1.8rem;
        font-weight: bold;
    }
    
    .excursion-item {
        display: flex;
        align-items: center;
        padding: 1rem;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        margin-bottom: 0.5rem;
        background: white;
    }
    
    .excursion-critical {
        border-left: 4px solid #f56565;
        background: #fed7d7;
    }
    
    .excursion-warning {
        border-left: 4px solid #ed8936;
        background: #faf089;
    }
    
    .report-filters {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        margin-bottom: 2rem;
    }
    
    .data-table {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }
    
    .table th {
        background: #f8fafc;
        border: none;
        font-weight: 600;
        color: #475569;
        padding: 1rem;
    }
    
    .table td {
        border: none;
        padding: 1rem;
        vertical-align: middle;
    }
    
    .temp-safe { background: #c6f6d5; color: #22543d; }
    .temp-warning { background: #faf089; color: #744210; }
    .temp-unsafe { background: #fed7d7; color: #742a2a; }
    
    .export-section {
        background: linear-gradient(135deg, #edf2f7 0%, #e2e8f0 100%);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .compliance-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .badge-compliant {
        background: #c6f6d5;
        color: #22543d;
    }
    
    .badge-non-compliant {
        background: #fed7d7;
        color: #742a2a;
    }
    
    .statistics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .stat-item {
        text-align: center;
        padding: 1.5rem;
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    }
    
    .stat-value {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }
    
    .stat-label {
        color: #718096;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .chart-container {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        margin-bottom: 2rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="compliance-header">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <h1 class="h2 mb-3">
                    <i class="fas fa-clipboard-check me-3"></i>
                    Temperature Compliance Report
                </h1>
                <p class="mb-0 opacity-90">
                    Detailed compliance analysis and temperature monitoring reports
                </p>
            </div>
            <div class="col-lg-4 text-lg-end">
                <button class="btn btn-light me-2" onclick="generateReport()">
                    <i class="fas fa-sync me-2"></i>Regenerate
                </button>
                <a href="{% url 'iot_mock:system_dashboard' %}" class="btn btn-light">
                    <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                </a>
            </div>
        </div>
    </div>

    <!-- Report Filters -->
    <div class="report-filters">
        <form method="get" class="row align-items-center">
            <div class="col-lg-4">
                <label for="location" class="form-label">Storage Location</label>
                <select name="location" id="location" class="form-select">
                    {% for location_id, location_data in available_locations.items %}
                        <option value="{{ location_id }}" {% if location_id == selected_location %}selected{% endif %}>
                            {{ location_data.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-lg-4">
                <label for="hours" class="form-label">Time Period</label>
                <select name="hours" id="hours" class="form-select">
                    <option value="24" {% if selected_hours == 24 %}selected{% endif %}>Last 24 Hours</option>
                    <option value="48" {% if selected_hours == 48 %}selected{% endif %}>Last 48 Hours</option>
                    <option value="72" {% if selected_hours == 72 %}selected{% endif %}>Last 72 Hours</option>
                    <option value="168" {% if selected_hours == 168 %}selected{% endif %}>Last Week</option>
                </select>
            </div>
            <div class="col-lg-4">
                <label class="form-label">&nbsp;</label>
                <div class="d-grid">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search me-2"></i>Generate Report
                    </button>
                </div>
            </div>
        </form>
    </div>

    {% if compliance_data %}
    <!-- Compliance Overview -->
    <div class="row mb-4">
        <div class="col-lg-4">
            <div class="compliance-card text-center">
                <h6 class="text-muted mb-3">Overall Compliance Rate</h6>
                <div class="compliance-ring">
                    <svg width="150" height="150">
                        <circle cx="75" cy="75" r="60" stroke="#e2e8f0" stroke-width="12" fill="none"/>
                        <circle cx="75" cy="75" r="60" 
                                stroke="{% if compliance_data.compliance_summary.compliance_rate >= 95 %}#48bb78{% elif compliance_data.compliance_summary.compliance_rate >= 85 %}#4299e1{% elif compliance_data.compliance_summary.compliance_rate >= 70 %}#ed8936{% else %}#f56565{% endif %}" 
                                stroke-width="12" fill="none"
                                stroke-dasharray="{{ compliance_data.compliance_summary.compliance_rate|floatformat:0 }}, 100"
                                stroke-dashoffset="25" transform="rotate(-90 75 75)"/>
                    </svg>
                    <div class="ring-score {% if compliance_data.compliance_summary.compliance_rate >= 95 %}score-excellent{% elif compliance_data.compliance_summary.compliance_rate >= 85 %}score-good{% elif compliance_data.compliance_summary.compliance_rate >= 70 %}score-warning{% else %}score-critical{% endif %}">
                        {{ compliance_data.compliance_summary.compliance_rate }}%
                    </div>
                </div>
                
                <div class="mt-3">
                    <span class="compliance-badge {% if compliance_data.compliance_summary.compliance_rate >= 95 %}badge-compliant{% else %}badge-non-compliant{% endif %}">
                        {% if compliance_data.compliance_summary.compliance_rate >= 95 %}
                            Fully Compliant
                        {% elif compliance_data.compliance_summary.compliance_rate >= 85 %}
                            Mostly Compliant
                        {% else %}
                            Non-Compliant
                        {% endif %}
                    </span>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="statistics-grid">
                <div class="stat-item">
                    <div class="stat-value text-success">{{ compliance_data.compliance_summary.safe_readings }}</div>
                    <div class="stat-label">Safe Readings</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value text-warning">{{ compliance_data.compliance_summary.warning_readings }}</div>
                    <div class="stat-label">Warning Readings</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value text-danger">{{ compliance_data.compliance_summary.unsafe_readings }}</div>
                    <div class="stat-label">Critical Readings</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value text-primary">{{ compliance_data.export_info.total_readings }}</div>
                    <div class="stat-label">Total Readings</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value text-info">{{ compliance_data.compliance_summary.temperature_excursions }}</div>
                    <div class="stat-label">Temperature Excursions</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value text-secondary">{{ compliance_data.export_info.period_hours }}h</div>
                    <div class="stat-label">Monitoring Period</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Current Status -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="compliance-card">
                <h6 class="mb-3">
                    <i class="fas fa-thermometer-half me-2 text-primary"></i>
                    Current Status - {{ compliance_data.current_status.location_name }}
                </h6>
                <div class="row">
                    <div class="col-lg-3 col-md-6">
                        <div class="text-center">
                            <div class="h3 temp-{{ compliance_data.current_status.status }}">
                                {{ compliance_data.current_status.temperature }}°C
                            </div>
                            <small class="text-muted">Current Temperature</small>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="text-center">
                            <div class="h5">{{ compliance_data.current_status.safe_min }}°C - {{ compliance_data.current_status.safe_max }}°C</div>
                            <small class="text-muted">Safe Range</small>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="text-center">
                            <span class="badge bg-{{ compliance_data.current_status.alert_level }} fs-6">
                                {{ compliance_data.current_status.status_text }}
                            </span>
                            <br>
                            <small class="text-muted">Current Status</small>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="text-center">
                            <div class="h5">{{ compliance_data.current_status.time_in_current_range }} min</div>
                            <small class="text-muted">Time in Range</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Temperature Excursions -->
    {% if compliance_data.excursion_details %}
    <div class="compliance-card">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="mb-0">
                <i class="fas fa-exclamation-triangle me-2 text-warning"></i>
                Temperature Excursions ({{ compliance_data.excursion_details|length }})
            </h6>
            <button class="btn btn-sm btn-outline-primary" onclick="exportExcursions()">
                <i class="fas fa-download me-2"></i>Export
            </button>
        </div>
        
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Temperature</th>
                        <th>Status</th>
                        <th>Deviation</th>
                        <th>Duration</th>
                    </tr>
                </thead>
                <tbody>
                    {% for excursion in compliance_data.excursion_details|slice:":10" %}
                    <tr>
                        <td>{{ excursion.timestamp }}</td>
                        <td>
                            <span class="temp-{{ excursion.status }}">
                                {{ excursion.temperature }}°C
                            </span>
                        </td>
                        <td>
                            <span class="badge bg-{% if excursion.status == 'safe' %}success{% elif excursion.status == 'warning' %}warning{% else %}danger{% endif %}">
                                {{ excursion.status|capfirst }}
                            </span>
                        </td>
                        <td>
                            {% if excursion.temperature < 2 %}
                                {{ excursion.temperature|floatformat:1|add:"-2" }}°C below minimum
                            {% elif excursion.temperature > 8 %}
                                +{{ excursion.temperature|floatformat:1|add:"-8" }}°C above maximum
                            {% else %}
                                Within range
                            {% endif %}
                        </td>
                        <td>
                            <span class="text-muted">~15 min</span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        {% if compliance_data.excursion_details|length > 10 %}
        <div class="text-center mt-3">
            <button class="btn btn-outline-primary" onclick="showAllExcursions()">
                View All {{ compliance_data.excursion_details|length }} Excursions
            </button>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Temperature History Chart -->
    <div class="chart-container">
        <h6 class="mb-3">
            <i class="fas fa-chart-line me-2 text-primary"></i>
            Temperature History ({{ compliance_data.export_info.period_hours }} hours)
        </h6>
        <canvas id="complianceChart" height="100"></canvas>
    </div>

    <!-- Export Section -->
    <div class="export-section">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <h6 class="mb-2">
                    <i class="fas fa-file-export me-2"></i>
                    Export Compliance Data
                </h6>
                <p class="mb-0 text-muted">
                    Download detailed compliance report for regulatory submissions and audit purposes.
                </p>
            </div>
            <div class="col-lg-4 text-lg-end">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary" onclick="exportReport('json')">
                        <i class="fas fa-file-code me-2"></i>JSON
                    </button>
                    <button type="button" class="btn btn-outline-success" onclick="exportReport('csv')">
                        <i class="fas fa-file-csv me-2"></i>CSV
                    </button>
                    <button type="button" class="btn btn-outline-danger" onclick="exportReport('pdf')">
                        <i class="fas fa-file-pdf me-2"></i>PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    {% else %}
    <!-- No Data State -->
    <div class="compliance-card text-center">
        <i class="fas fa-chart-line fa-4x text-muted mb-3"></i>
        <h4>No Compliance Data Available</h4>
        <p class="text-muted mb-4">
            Select a location and time period to generate a compliance report.
        </p>
        <button class="btn btn-primary" onclick="document.getElementById('location').focus()">
            <i class="fas fa-search me-2"></i>Generate Report
        </button>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    {% if compliance_data %}
    // Initialize compliance chart
    const ctx = document.getElementById('complianceChart').getContext('2d');
    const temperatureData = {{ compliance_data.temperature_data|safe }};
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: temperatureData.map(item => new Date(item.timestamp).toLocaleTimeString()),
            datasets: [{
                label: 'Temperature (°C)',
                data: temperatureData.map(item => item.temperature),
                borderColor: function(context) {
                    const dataIndex = context.dataIndex;
                    const status = temperatureData[dataIndex].status;
                    return status === 'safe' ? '#48bb78' : 
                           status === 'warning' ? '#ed8936' : '#f56565';
                },
                backgroundColor: 'rgba(66, 153, 225, 0.1)',
                pointBackgroundColor: function(context) {
                    const dataIndex = context.dataIndex;
                    const status = temperatureData[dataIndex].status;
                    return status === 'safe' ? '#48bb78' : 
                           status === 'warning' ? '#ed8936' : '#f56565';
                },
                pointBorderWidth: 2,
                pointRadius: 3,
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index'
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            const dataIndex = context[0].dataIndex;
                            return new Date(temperatureData[dataIndex].timestamp).toLocaleString();
                        },
                        label: function(context) {
                            const dataIndex = context.dataIndex;
                            const temp = context.parsed.y;
                            const status = temperatureData[dataIndex].status;
                            return `Temperature: ${temp}°C (${status.charAt(0).toUpperCase() + status.slice(1)})`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: false,
                    min: Math.min(...temperatureData.map(item => item.temperature)) - 2,
                    max: Math.max(...temperatureData.map(item => item.temperature)) + 2,
                    grid: {
                        color: function(context) {
                            if (context.tick.value === 2 || context.tick.value === 8) {
                                return '#48bb78';
                            }
                            return 'rgba(0, 0, 0, 0.1)';
                        }
                    },
                    ticks: {
                        callback: function(value) {
                            return value + '°C';
                        }
                    }
                },
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        maxTicksLimit: 12
                    }
                }
            },
            elements: {
                point: {
                    hoverRadius: 8
                }
            }
        }
    });

    // Add safe zone annotation
    Chart.register({
        id: 'safeZonePlugin',
        beforeDraw: function(chart) {
            const ctx = chart.ctx;
            const chartArea = chart.chartArea;
            const yScale = chart.scales.y;
            
            // Draw safe zone
            const safeMinY = yScale.getPixelForValue(2);
            const safeMaxY = yScale.getPixelForValue(8);
            
            ctx.save();
            ctx.fillStyle = 'rgba(72, 187, 120, 0.1)';
            ctx.fillRect(chartArea.left, safeMaxY, chartArea.right - chartArea.left, safeMinY - safeMaxY);
            ctx.restore();
        }
    });
    {% endif %}
});

function generateReport() {
    const form = document.querySelector('form');
    form.submit();
}

function exportReport(format) {
    const location = document.getElementById('location').value;
    const hours = document.getElementById('hours').value;
    
    let url;
    if (format === 'json') {
        url = `{% url 'iot_mock:export_data' %}?location=${location}&hours=${hours}`;
        
        // Create download link for JSON
        const link = document.createElement('a');
        link.href = url;
        link.download = `compliance_report_${location}_${hours}h.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    } else {
        // For CSV and PDF, we would need additional endpoints
        showToast(`${format.toUpperCase()} export will be available soon`, 'info');
    }
}

function exportExcursions() {
    const location = document.getElementById('location').value;
    const hours = document.getElementById('hours').value;
    
    // This would export just the excursions data
    fetch(`{% url 'iot_mock:export_data' %}?location=${location}&hours=${hours}`)
        .then(response => response.json())
        .then(data => {
            const excursions = data.excursion_details;
            const blob = new Blob([JSON.stringify(excursions, null, 2)], {
                type: 'application/json'
            });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `temperature_excursions_${location}_${hours}h.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        })
        .catch(error => {
            console.error('Export error:', error);
            showToast('Error exporting excursions data', 'danger');
        });
}

function showAllExcursions() {
    // This would show a modal or navigate to a detailed excursions view
    showToast('Detailed excursions view coming soon', 'info');
}

function showToast(message, type = 'info') {
    // Simple toast notification
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(toast);
    
    // Auto-remove after 3 seconds
    setTimeout(() => {
        if (toast.parentNode) {
            toast.remove();
        }
    }, 3000);
}

// Auto-save report settings
document.getElementById('location').addEventListener('change', function() {
    localStorage.setItem('compliance_location', this.value);
});

document.getElementById('hours').addEventListener('change', function() {
    localStorage.setItem('compliance_hours', this.value);
});

// Restore saved settings
document.addEventListener('DOMContentLoaded', function() {
    const savedLocation = localStorage.getItem('compliance_location');
    const savedHours = localStorage.getItem('compliance_hours');
    
    if (savedLocation) {
        document.getElementById('location').value = savedLocation;
    }
    if (savedHours) {
        document.getElementById('hours').value = savedHours;
    }
});
</script>
{% endblock %}