{% extends 'base.html' %}
{% load static %}
{% load forecast_extras %}

{% block title %}Drug Comparison - DrugTrack{% endblock %}

{% block content %}
<div class="space-y-8">
    <!-- Header -->
    <div class="glass-effect rounded-2xl p-6 md:p-8">
        <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
            <div>
                <h1 class="text-3xl md:text-4xl font-bold text-white mb-2 flex items-center">
                    <i class="bi bi-ui-checks-grid mr-3"></i>
                    Drug Comparison
                </h1>
                <p class="text-white/80 max-w-2xl">
                    Compare demand patterns, trends, and forecasts across multiple drugs side-by-side.
                </p>
            </div>
            <div class="flex-shrink-0 flex items-center gap-2">
                <a href="{% url 'ai_forecast:forecast' %}" class="bg-white/10 hover:bg-white/20 text-white font-medium py-2 px-4 rounded-lg transition-all duration-300 flex items-center space-x-2">
                    <i class="bi bi-graph-up-arrow"></i>
                    <span>Forecast</span>
                </a>
                 <a href="{% url 'ai_forecast:analytics' %}" class="bg-white/10 hover:bg-white/20 text-white font-medium py-2 px-4 rounded-lg transition-all duration-300 flex items-center space-x-2">
                    <i class="bi bi-bar-chart-line-fill"></i>
                    <span>Analytics</span>
                </a>
            </div>
        </div>
    </div>

    <!-- Drug Selection Card -->
    <div class="bg-white/95 backdrop-blur-sm rounded-2xl shadow-xl p-6">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 items-center">
            <div>
                <label for="drugSelector" class="block text-lg font-semibold text-gray-800 mb-2">Select Drugs to Compare (up to 5)</label>
                 <!-- NOTE: A standard multi-select is hard to style. This is a functional placeholder. For a truly custom look, a JS library like TomSelect or Select2 would be needed. -->
                <select id="drugSelector" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" multiple>
                    {% for drug in available_drugs %}
                        <option value="{{ drug }}" {% if drug in selected_drugs %}selected{% endif %}>
                            {{ drug }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div>
                 <p class="text-md font-semibold text-gray-800 mb-2">Currently Selected:</p>
                 <div id="selectedDrugs" class="flex flex-wrap gap-2 min-h-[40px]">
                     {% for drug in selected_drugs %}
                        <span class="inline-flex items-center bg-indigo-100 text-indigo-800 text-sm font-medium px-3 py-1 rounded-full" data-drug="{{ drug }}">
                            {{ drug }}
                            <button type="button" class="ml-2 text-indigo-600 hover:text-indigo-800" onclick="removeDrug('{{ drug }}')">&times;</button>
                        </span>
                    {% endfor %}
                    {% if not selected_drugs %}
                        <span class="text-gray-500 italic">No drugs selected.</span>
                    {% endif %}
                 </div>
                 <button id="compareBtn" class="mt-4 bg-gradient-to-r from-blue-600 to-purple-600 text-white px-6 py-3 rounded-lg font-medium hover:from-blue-700 hover:to-purple-700 transform hover:scale-105 transition-all duration-300 shadow-lg flex items-center justify-center space-x-2">
                    <i class="bi bi-arrow-clockwise"></i>
                    <span>Update Comparison</span>
                </button>
            </div>
        </div>
    </div>
    
    {% if selected_drugs and comparison_data %}
    <!-- Comparison Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-{{ selected_drugs|length|default:'3' }} gap-6">
        {% for drug in selected_drugs %}
        <div class="bg-white/95 backdrop-blur-sm rounded-2xl shadow-xl border-t-4 border-indigo-500 p-6 flex flex-col justify-between">
            <div>
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-900">{{ drug }}</h3>
                    <span class="text-lg font-semibold {% if comparison_data|lookup:drug|lookup:'trend' == 'increasing' %}text-green-600{% else %}text-red-600{% endif %}">
                        {% if comparison_data|lookup:drug|lookup:'trend' == 'increasing' %}
                            <i class="bi bi-arrow-up-right"></i>
                        {% else %}
                            <i class="bi bi-arrow-down-right"></i>
                        {% endif %}
                    </span>
                </div>
                <div class="space-y-4">
                    <div>
                        <p class="text-sm text-gray-600">30-Day Forecast Avg.</p>
                        <p class="text-2xl font-bold text-gray-800">{{ comparison_data|lookup:drug|lookup:'forecast_avg'|floatformat:0 }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">30-Day Historical Avg.</p>
                        <p class="text-2xl font-bold text-gray-800">{{ comparison_data|lookup:drug|lookup:'historical_avg'|floatformat:0 }}</p>
                    </div>
                </div>
            </div>
            <a href="{% url 'ai_forecast:forecast' %}?drug={{ drug|urlencode }}" class="mt-6 block text-center w-full bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium py-2 px-4 rounded-lg transition-all">
                View Full Forecast
            </a>
        </div>
        {% endfor %}
    </div>

    <!-- Visualization -->
     <div class="bg-white/95 backdrop-blur-sm rounded-2xl shadow-xl p-6">
        <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">
            <i class="bi bi-radar mr-2 text-indigo-500"></i>
            Multi-Drug Performance Radar
        </h3>
        <div class="relative h-96">
            <canvas id="comparisonChart"></canvas>
        </div>
     </div>

    {% else %}
    <!-- Empty State -->
    <div class="bg-white/95 backdrop-blur-sm rounded-2xl shadow-xl text-center p-12">
        <div class="mx-auto bg-indigo-100 text-indigo-600 w-16 h-16 rounded-full flex items-center justify-center">
            <i class="bi bi-ui-checks-grid text-3xl"></i>
        </div>
        <h2 class="mt-6 text-2xl font-bold text-gray-900">Select Drugs to Get Started</h2>
        <p class="mt-2 text-gray-600">Choose 2 to 5 drugs from the dropdown above to compare their demand patterns and forecasts.</p>
        <button class="mt-6 bg-indigo-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-indigo-700 transition-all" onclick="document.getElementById('drugSelector').focus()">
            Start Selecting
        </button>
    </div>
    {% endif %}

</div>
{% endblock %}


{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const drugSelector = document.getElementById('drugSelector');
    const compareBtn = document.getElementById('compareBtn');
    const selectedDrugsContainer = document.getElementById('selectedDrugs');
    
    if (drugSelector) {
        drugSelector.addEventListener('change', updateSelectedDrugsUI);
    }
    if (compareBtn) {
        compareBtn.addEventListener('click', performComparison);
    }
    
    function updateSelectedDrugsUI() {
        const selectedOptions = Array.from(drugSelector.selectedOptions);
        
        // Limit selection to 5
        if (selectedOptions.length > 5) {
            alert('You can select a maximum of 5 drugs for comparison.');
            // Deselect the last selected option
            selectedOptions[selectedOptions.length - 1].selected = false;
            return;
        }

        selectedDrugsContainer.innerHTML = '';
        if (selectedOptions.length === 0) {
            selectedDrugsContainer.innerHTML = '<span class="text-gray-500 italic">No drugs selected.</span>';
        } else {
            selectedOptions.forEach(option => {
                const drug = option.value;
                const chip = document.createElement('span');
                chip.className = 'inline-flex items-center bg-indigo-100 text-indigo-800 text-sm font-medium px-3 py-1 rounded-full';
                chip.dataset.drug = drug;
                chip.innerHTML = `${drug} <button type="button" class="ml-2 text-indigo-600 hover:text-indigo-800" onclick="removeDrug('${drug}')">&times;</button>`;
                selectedDrugsContainer.appendChild(chip);
            });
        }
    }
    
    function performComparison() {
        const selected = Array.from(drugSelector.selectedOptions).map(option => option.value);
        if (selected.length < 2) {
            alert('Please select at least 2 drugs for an effective comparison.');
            return;
        }
        
        const params = new URLSearchParams();
        selected.forEach(drug => params.append('drugs', drug));
        window.location.href = `{% url 'ai_forecast:comparison' %}?${params.toString()}`;
    }
    
    // Initialize Chart.js radar chart
    {% if selected_drugs and comparison_data %}
    const ctx = document.getElementById('comparisonChart')?.getContext('2d');
    if (ctx) {
        const chartData = {
            labels: ['Forecast Demand', 'Historical Demand', 'Growth Potential'],
            datasets: [
                {% for drug in selected_drugs %}
                {
                    label: '{{ drug }}',
                    data: [
                        {{ comparison_data|lookup:drug|lookup:'forecast_avg'|default:0 }},
                        {{ comparison_data|lookup:drug|lookup:'historical_avg'|default:0 }},
                        {% if comparison_data|lookup:drug|lookup:'trend' == 'increasing' %}85{% else %}40{% endif %},
                    ],
                    backgroundColor: `hsla({{ forloop.counter0|multiply:75 }}, 90%, 70%, 0.2)`,
                    borderColor: `hsl({{ forloop.counter0|multiply:75 }}, 90%, 60%)`,
                    borderWidth: 2,
                    pointBackgroundColor: `hsl({{ forloop.counter0|multiply:75 }}, 90%, 60%)`
                },
                {% endfor %}
            ]
        };
        
        new Chart(ctx, {
            type: 'radar',
            data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    r: {
                        beginAtZero: true,
                         grid: { color: 'rgba(0,0,0,0.05)' },
                         angleLines: { color: 'rgba(0,0,0,0.05)' },
                         pointLabels: { font: { size: 14 } }
                    }
                },
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
    }
    {% endif %}
});

function removeDrug(drugName) {
    const selector = document.getElementById('drugSelector');
    if (selector) {
        Array.from(selector.options).forEach(option => {
            if (option.value === drugName) {
                option.selected = false;
            }
        });
        // Manually trigger the change event to update the UI
        selector.dispatchEvent(new Event('change'));
    }
}
</script>
{% endblock %}
