{% extends 'base.html' %}
{% load static %}
{% load forecast_extras %}

{% block title %}Forecast Analytics - DrugTrack{% endblock %}

{% block content %}
<div class="space-y-8">
    <!-- Header -->
    <div class="glass-effect rounded-2xl p-6 md:p-8">
        <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
            <div>
                <h1 class="text-3xl md:text-4xl font-bold text-white mb-2 flex items-center">
                    <i class="bi bi-bar-chart-line-fill mr-3"></i>
                    Forecast Analytics
                </h1>
                <p class="text-white/80 max-w-2xl">
                    In-depth analysis of drug demand patterns, growth trends, and risk assessments.
                </p>
            </div>
            <a href="{% url 'ai_forecast:forecast' %}" class="bg-white/10 hover:bg-white/20 text-white font-medium py-2 px-4 rounded-lg transition-all duration-300 flex items-center space-x-2 flex-shrink-0">
                <i class="bi bi-arrow-left"></i>
                <span>Back to Forecast</span>
            </a>
        </div>
    </div>

    <!-- Key Metrics Grid -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
        <!-- Metric Card: Total Drugs -->
        <div class="bg-white/95 backdrop-blur-sm rounded-2xl shadow-xl p-6 flex items-center space-x-4 border-l-4 border-indigo-500">
            <div class="bg-indigo-100 text-indigo-600 rounded-full p-3 text-2xl">
                <i class="bi bi-capsule"></i>
            </div>
            <div>
                <p class="text-sm text-gray-600 font-medium">Total Drugs Tracked</p>
                <p class="text-3xl font-bold text-gray-900">{{ total_drugs }}</p>
            </div>
        </div>
        <!-- Metric Card: Annual Demand -->
        <div class="bg-white/95 backdrop-blur-sm rounded-2xl shadow-xl p-6 flex items-center space-x-4 border-l-4 border-green-500">
            <div class="bg-green-100 text-green-600 rounded-full p-3 text-2xl">
                <i class="bi bi-stack"></i>
            </div>
            <div>
                <p class="text-sm text-gray-600 font-medium">Annual Demand</p>
                <p class="text-3xl font-bold text-gray-900">{{ total_demand|floatformat:0 }}</p>
            </div>
        </div>
        <!-- Metric Card: Avg Volatility -->
        <div class="bg-white/95 backdrop-blur-sm rounded-2xl shadow-xl p-6 flex items-center space-x-4 border-l-4 border-yellow-500">
            <div class="bg-yellow-100 text-yellow-600 rounded-full p-3 text-2xl">
                <i class="bi bi-exclamation-diamond"></i>
            </div>
            <div>
                <p class="text-sm text-gray-600 font-medium">Avg. Volatility</p>
                <p class="text-3xl font-bold text-gray-900">{{ avg_volatility }}</p>
            </div>
        </div>
        <!-- Metric Card: High Growth Drugs -->
        <div class="bg-white/95 backdrop-blur-sm rounded-2xl shadow-xl p-6 flex items-center space-x-4 border-l-4 border-blue-500">
            <div class="bg-blue-100 text-blue-600 rounded-full p-3 text-2xl">
                <i class="bi bi-graph-up"></i>
            </div>
            <div>
                <p class="text-sm text-gray-600 font-medium">High-Growth Drugs</p>
                <p class="text-3xl font-bold text-gray-900">{{ high_growth_drugs|length }}</p>
            </div>
        </div>
    </div>

    <!-- Top Performing Drugs Table -->
    <div class="bg-white/95 backdrop-blur-sm rounded-2xl shadow-xl overflow-hidden">
        <div class="p-5 bg-gradient-to-r from-gray-50 to-gray-100 border-b border-gray-200">
            <h2 class="text-xl font-bold text-gray-800 flex items-center">
                <i class="bi bi-trophy-fill text-yellow-500 mr-3"></i>Top Performing Drugs
            </h2>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-sm text-left text-gray-600">
                <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                    <tr>
                        <th scope="col" class="px-6 py-3">Rank</th>
                        <th scope="col" class="px-6 py-3">Drug Name</th>
                        <th scope="col" class="px-6 py-3 text-center">Annual Demand</th>
                        <th scope="col" class="px-6 py-3 text-center">Market Share</th>
                        <th scope="col" class="px-6 py-3 text-center">Growth Rate</th>
                        <th scope="col" class="px-6 py-3 text-center">Risk Level</th>
                    </tr>
                </thead>
                <tbody>
                    {% for drug in top_drugs %}
                    <tr class="bg-white border-b hover:bg-gray-50">
                        <td class="px-6 py-4 font-bold text-gray-900 text-center">
                            <span class="bg-indigo-100 text-indigo-800 text-xs font-semibold px-2.5 py-1 rounded-full">{{ drug.rank }}</span>
                        </td>
                        <th scope="row" class="px-6 py-4 font-bold text-gray-900 whitespace-nowrap">{{ drug.drug_name }}</th>
                        <td class="px-6 py-4 text-center">{{ drug.total_annual_demand|floatformat:0 }}</td>
                        <td class="px-6 py-4 text-center">{{ drug.percentage_of_total }}%</td>
                        <td class="px-6 py-4 text-center">
                             {% with growth=summary_stats|lookup:drug.drug_name|lookup:'monthly_growth_rate' %}
                                <span class="inline-flex items-center text-xs font-semibold px-2.5 py-1 rounded-full 
                                    {% if growth > 0 %} bg-green-100 text-green-800 {% elif growth < 0 %} bg-red-100 text-red-800 {% else %} bg-gray-100 text-gray-800 {% endif %}">
                                    {% if growth > 0 %}<i class="bi bi-arrow-up-right mr-1"></i>{% elif growth < 0 %}<i class="bi bi-arrow-down-right mr-1"></i>{% endif %}
                                    {{ growth|floatformat:1 }}%
                                </span>
                            {% endwith %}
                        </td>
                        <td class="px-6 py-4 text-center">
                             {% with volatility=summary_stats|lookup:drug.drug_name|lookup:'demand_volatility' %}
                                {% if volatility > avg_volatility|multiply:1.5 %}
                                    <span class="text-red-600 font-semibold"><i class="bi bi-exclamation-circle-fill mr-1"></i>High</span>
                                {% elif volatility > avg_volatility %}
                                    <span class="text-yellow-600 font-semibold"><i class="bi bi-exclamation-triangle-fill mr-1"></i>Medium</span>
                                {% else %}
                                    <span class="text-green-600 font-semibold"><i class="bi bi-check-circle-fill mr-1"></i>Low</span>
                                {% endif %}
                            {% endwith %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Insights Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Growth Opportunities -->
        <div class="bg-white/95 backdrop-blur-sm rounded-2xl shadow-xl p-6">
            <div class="flex items-center text-green-600 mb-3">
                <i class="bi bi-graph-up-arrow text-2xl"></i>
                <h3 class="text-lg font-bold text-gray-800 ml-2">Growth Opportunities</h3>
            </div>
            <p class="text-gray-600 text-sm mb-3">
                {{ high_growth_drugs|length }} drugs show strong growth (>5%/month). Consider increasing stock for these items.
            </p>
            <div class="flex flex-wrap gap-2">
                {% for drug in high_growth_drugs|slice:":4" %}
                    <span class="bg-green-100 text-green-800 text-xs font-semibold px-2.5 py-1 rounded-full">{{ drug }}</span>
                {% endfor %}
            </div>
        </div>
        <!-- Risk Management -->
        <div class="bg-white/95 backdrop-blur-sm rounded-2xl shadow-xl p-6">
            <div class="flex items-center text-yellow-600 mb-3">
                <i class="bi bi-shield-exclamation text-2xl"></i>
                <h3 class="text-lg font-bold text-gray-800 ml-2">Risk Management</h3>
            </div>
            <p class="text-gray-600 text-sm mb-3">
                {{ high_risk_drugs|length }} drugs have high demand volatility. Monitor stock levels closely to prevent shortages.
            </p>
            <div class="flex flex-wrap gap-2">
                 {% for drug in high_risk_drugs|slice:":4" %}
                    <span class="bg-yellow-100 text-yellow-800 text-xs font-semibold px-2.5 py-1 rounded-full">{{ drug }}</span>
                {% endfor %}
            </div>
        </div>
        <!-- Market Concentration -->
        <div class="bg-white/95 backdrop-blur-sm rounded-2xl shadow-xl p-6">
            <div class="flex items-center text-indigo-600 mb-3">
                <i class="bi bi-pie-chart-fill text-2xl"></i>
                <h3 class="text-lg font-bold text-gray-800 ml-2">Market Concentration</h3>
            </div>
            <p class="text-gray-600 text-sm mb-3">
                The top performer, <strong class="text-gray-900">{{ top_drugs.0.drug_name }}</strong>, accounts for a significant <strong class="text-gray-900">{{ top_drugs.0.percentage_of_total }}%</strong> of total demand.
            </p>
        </div>
    </div>
</div>
{% endblock %}
